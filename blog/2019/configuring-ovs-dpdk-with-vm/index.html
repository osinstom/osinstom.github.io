<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Configuring OVS-DPDK with VM | Making networks truly programmable! </title> <meta name="author" content="Tomasz Osiński"> <meta name="description" content="Making networks programmable by Tomasz Osiński "> <meta name="keywords" content="5G, Software-Defined Networking, NFV, P4, Telco Cloud"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?31447096772a8933d0b4c90f26018e76"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://osinstom.github.io/blog/2019/configuring-ovs-dpdk-with-vm/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Making networks truly programmable! </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/about">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Configuring OVS-DPDK with VM</h1> <p class="post-meta"> March 23, 2019 </p> <p class="post-tags"> <a href="/blog/2019"> <i class="fa-solid fa-calendar fa-sm"></i> 2019 </a>   ·   <a href="/blog/tag/nfv"> <i class="fa-solid fa-hashtag fa-sm"></i> NFV</a>   <a href="/blog/tag/ovs-dpdk"> <i class="fa-solid fa-hashtag fa-sm"></i> OVS-DPDK</a>   <a href="/blog/tag/performance"> <i class="fa-solid fa-hashtag fa-sm"></i> Performance</a>   <a href="/blog/tag/dpdk"> <i class="fa-solid fa-hashtag fa-sm"></i> DPDK</a>   <a href="/blog/tag/linux"> <i class="fa-solid fa-hashtag fa-sm"></i> Linux</a>     ·   <a href="/blog/category/tutorial"> <i class="fa-solid fa-tag fa-sm"></i> tutorial</a>   </p> </header> <article class="post-content"> <div id="table-of-contents"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h2"> <a href="#configuring-ovs-dpdk-with-vm-for-performance-testing">Configuring OVS-DPDK with VM for performance testing</a> <ul> <li class="toc-entry toc-h3"><a href="#prerequisites">Prerequisites</a></li> <li class="toc-entry toc-h3"><a href="#installing-ovs-dpdk">Installing OVS-DPDK</a></li> <li class="toc-entry toc-h3"><a href="#configuring-ovs-dpdk">Configuring OVS-DPDK</a></li> <li class="toc-entry toc-h3"><a href="#running-kvm-machine">Running KVM machine</a></li> <li class="toc-entry toc-h3"><a href="#summary">Summary</a></li> </ul> </li> </ul> </div> <hr> <div id="markdown-content"> <h2 id="configuring-ovs-dpdk-with-vm-for-performance-testing">Configuring OVS-DPDK with VM for performance testing</h2> <p>Recently, I work on a performance comparison between virtualization technologies. In order to made an experiment I had had to setup a test environment based on <a href="https://software.intel.com/en-us/articles/open-vswitch-with-dpdk-overview" rel="external nofollow noopener" target="_blank">OVS-DPDK</a> and <a href="https://www.redhat.com/en/topics/virtualization/what-is-KVM" rel="external nofollow noopener" target="_blank">KVM-based Virtual Machine</a>. This user guide shows how to install and configure the test scenario with OVS-DPDK and libvirt. The test scenario is presented below. According to OVS flow rules configuration we can test PHY-OVS-PHY scenario (green line) or PHY-VM-PHY scenario (red line).</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/OVS-DPDK-VM/test-scenario-ovs-dpdk-480.webp 480w,/assets/img/OVS-DPDK-VM/test-scenario-ovs-dpdk-800.webp 800w,/assets/img/OVS-DPDK-VM/test-scenario-ovs-dpdk-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/OVS-DPDK-VM/test-scenario-ovs-dpdk.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> The OVS-DPDK + VM scenario </div> <h3 id="prerequisites">Prerequisites</h3> <p>Before starting installation of OVS-DPDK and VMs, let’s prepare OS.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get update
sudo apt-get upgrade

sudo apt-get -y install git qemu-system-x86 python-pip fuse libfuse-dev dh-autoreconf openssl libssl-dev cmake libpcap-dev python-yaml libnuma-dev
</code></pre></div></div> <h3 id="installing-ovs-dpdk">Installing OVS-DPDK</h3> <p>Firstly, we need to install DPDK and Open vSwitch from a source code. To install DPDK run below commands:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd $HOME &amp; mkdir dpdk
cd dpdk/
wget http://fast.dpdk.org/rel/dpdk-18.11.tar.xz
tar xf dpdk-18.11.tar.xz
cd dpdk-18.11/
</code></pre></div></div> <p>Then, we need to export environment variables, which point out to DPDK..</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export DPDK_DIR=$HOME/dpdk/dpdk-18.11
export DPDK_TARGET=x86_64-native-linuxapp-gcc
export DPDK_BUILD=$DPDK_DIR/$DPDK_TARGET
</code></pre></div></div> <p>.. and install DPDK. Note that we are using special flags (<em>-g -Ofast -march=native -Q</em>) to achieve a better performance of OVS-DPDK.</p> <p><code class="language-plaintext highlighter-rouge">EXTRA_CFLAGS="-g -Ofast" make install -j T=$target CONFIG_RTE_BUILD_COMBINE_LIBS=y CONFIG_RTE_LIBRTE_VHOST=y DESTDIR=install</code></p> <p>If the installation of DPDK has been successful, you can install OVS-DPDK.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd $HOME/dpdk/
git clone https://github.com/openvswitch/ovs
cd ovs
./boot.sh
./configure CFLAGS="-g -Ofast" --with-dpdk=$DPDK_BUILD
make -j CFLAGS="-g -Ofast -march=native -Q"
sudo make install
</code></pre></div></div> <p>Now, you should be able to verify OVS-DPDK installation by using below commands:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tomek@s14-2:~$ sudo ovs-vsctl show
3bb620bf-4d6f-4ddc-94ff-03f1ff9ccc93
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tomek@s14-2:~$ sudo ovs-vswitchd --version
ovs-vswitchd (Open vSwitch) 2.11.90
DPDK 18.11.0
</code></pre></div></div> <h3 id="configuring-ovs-dpdk">Configuring OVS-DPDK</h3> <p>Firstly, let’s configure DPDK ports. Following commands inject required kernel driver (i.e. uio, igb_uio, vfio). It is up to you, which one you would like to use. In order to choose one refer to https://doc.dpdk.org/guides/linux_gsg/linux_drivers.html. For our purposes we have used <em>uiopcigeneric</em>.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd dpdk/dpdk-18.11/usertools/
sudo modprobe uio_pci_generic
</code></pre></div></div> <p>Once kernel module has been injected NICs can be attached to DPDK. Note that you need to use the <em>bus-info</em> format (e.g.0000:88:00.0). To retrieve NIC ID in the bus-info format use:</p> <p><code class="language-plaintext highlighter-rouge">lspci | grep Ethernet</code></p> <p>This command will list all interfaces along with the bus-info identifier. Then, use dpdk-devbind.py script to bind chosen interfaces with DPDK drivers.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> ./dpdk-devbind.py <span class="nt">-b</span> uio_pci_generic 0000:88:00.0
<span class="nb">sudo</span> ./dpdk-devbind.py <span class="nt">-b</span> uio_pci_generic 0000:88:00.1
</code></pre></div></div> <p>You can check if interfaces have been bound successfully using:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tomek@s14-2:~/dpdk/dpdk-18.11$ usertools/dpdk-devbind.py --status

Network devices using DPDK-compatible driver
============================================
0000:88:00.0 '82599ES 10-Gigabit SFI/SFP+ Network Connection 10fb' drv=uio_pci_generic unused=ixgbe
0000:88:00.1 '82599ES 10-Gigabit SFI/SFP+ Network Connection 10fb' drv=uio_pci_generic unused=ixgbe
</code></pre></div></div> <p>Under “Network devices using DPDK-compatible driver” you should see the list of ports, which are already bound to the DPDK-compatible driver.</p> <p>Once Ethernet interfaces have been bound to DPDK, it’s time to mount hugepages. Hugepages are contiguous regions - segments of physical memory. In order to allocate hugepages persistently I have added following parameters to GRUB_CMDLINE_LINUX_DEFAULT in <em>/etc/default/grub</em>:</p> <p><code class="language-plaintext highlighter-rouge">GRUB_CMDLINE_LINUX_DEFAULT="default_hugepagesz=1G hugepagesz=1G hugepages=16 hugepagesz=2M hugepages=2048"</code></p> <p>Then, upgrade grub and reboot a machine:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo update-grub
sudo reboot
</code></pre></div></div> <p>This configuration will take effect after every system reboot and will result in allocating 16 hugepages of the 1G size.</p> <p>After reboot, you need only to mount hugepages using:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo mkdir -p /mnt/huge
sudo mount -t hugetlbfs nodev /mnt/huge
</code></pre></div></div> <p>To validate if hugepages has been allocated properly by:</p> <p><code class="language-plaintext highlighter-rouge">grep -i huge /proc/meminfo</code></p> <p>The number of free hugepages should be less than total number of available hugepages.</p> <p>Great, the DPDK environment should be configured properly now. We can move to the configuration of OVS. Firstly initialize OVS brigde with DPDK capabilities:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo ovs-vsctl --no-wait init
sudo ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=true
</code></pre></div></div> <p>The dpdk-init=true should be applied. To validate use below command, which should return the <em>true</em> value.</p> <p><code class="language-plaintext highlighter-rouge">sudo ovs-vsctl get Open_vSwitch . dpdk_initialized</code></p> <p>Now, we need to define other OVS parameters to be used by the DPDK ports. These are:</p> <ul> <li> <strong>other_config:dpdk-hugepage-dir</strong> - points to a directory, where hugepages are mounted.</li> <li> <strong>other_config:dpdk-socket-mem</strong> - a comma seperated list of hugepage memory, specified in MBs per NUMA node, allocated to the ovs-vswitchd to use for the DPDK dataplane</li> <li> <strong>other_config:dpdk-lcore-mask</strong> - a bitmask of what CPU core to pin to non-dataplane threads of the ovs-vswitchd to.</li> <li> <strong>other_config:pmd-cpu-mask</strong> - a bitmask of what CPU core to pin to the dataplane-related (Poll Mode Driver, PMD) threads of the ovs-vswitchd to. Each bit set in the bitmask result in the creating of the PMD thread.</li> <li> <strong>other_config:pmd-rxq-affinity</strong> - it is set per Interface. It pins a queue of port to the given CPU core. This parameter is optional, but in some circumstances it can be used to pin a queue of port to the specific CPU core.</li> </ul> <p>The first two options are quite straightforward and can be configured with:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-socket-mem="4096M"
sudo ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-hugepage-dir="/mnt/huge"
</code></pre></div></div> <p>Now, to configure <em>dpdk-lcore-mask</em> and <em>pmd-cpu-mask</em> we need to find out how our server is configured. In particular, we need to know how many NUMA nodes our server has and how CPU cores are allocated across NUMA nodes.</p> <p>Just to clarify, NUMA stands for Non-Uniform Memory Access. In NUMA system memory is divided into zones called nodes, which are allocated to particular CPUs or sockets. Access to memory that is local to a CPU is faster than memory connected to remote CPUs on that system. Normally, each socket on a NUMA system has a local memory node whose contents can be accessed faster than the memory in the node local to another CPU or the memory on a bus shared by all CPUs.</p> <p>Thus, in order to achieve better performance CPU cores used by OVS-DPDK should be located on the same NUMA node as DPDK ports. So, we configure OVS-DPDK with NUMA-awareness. In order to check NUMA topology on the server use:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lscpu
--- 

NUMA node0 CPU(s):     0-9,20-29
NUMA node1 CPU(s):     10-19,30-39
</code></pre></div></div> <p>In our case we have two NUMA nodes (0 and 1). The CPU cores 0-9 and 20-29 are associated with NUMA node0, while the others are associated with NUMA node1.</p> <p>Now, for the physical ports (88:00.0 and 88:00.1 in our case), which will be connected to OVS-DPDK we should check the associated NUMA node:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat /sys/bus/pci/devices/0000:88:00.0/numa_node
1
cat /sys/bus/pci/devices/0000:88:00.1/numa_node
1
</code></pre></div></div> <p><strong>As our NICs are associated with the NUMA node 1 we should dedicate CPU cores in the same NUMA node to run PMD threads.</strong> From the <em>lscpu</em> command’s output we know we should use CPU cores from range 10-19 or 30-39. So, let’s configure remaining parameters (we don’t configure <em>pmd-rxq-affinity</em>):</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-lcore-mask=""
sudo ovs-vsctl --no-wait set Open_vSwitch . other_config:pmd-cpu-mask=""
</code></pre></div></div> <p>Once DPDK parameters for OVS are configured, let’s run OVS-DPDK bridge. To create OVS-DPDK bridge use type=netdev:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo ovs-vsctl add-br br0
sudo ovs-vsctl set Bridge br0 datapath_type=netdev
</code></pre></div></div> <p>And add physical ports to OVS-DPDK:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo ovs-vsctl add-port br0 ens4f0 -- set Interface ens4f0 type=dpdk \
            options:dpdk-devargs=0000:88:00.0 \
            options:n_rxq=2 \
            ofport_request=1

sudo ovs-vsctl add-port br0 ens4f1 -- set Interface ens4f1 type=dpdk \
            options:dpdk-devargs=0000:88:00.1 \
            options:n_rxq=2 \
            ofport_request=2
</code></pre></div></div> <p>In our case we want also to attach VM to OVS-DPDK, so we create also two virtual ports (type=dpdkvhostuser). These ports will be later used by VM.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo ovs-vsctl add-port br0 dpdkvhostuser0 -- set Interface dpdkvhostuser0 type=dpdkvhostuser ofport_request=3

sudo ovs-vsctl add-port br0 dpdkvhostuser1 -- set Interface dpdkvhostuser1 type=dpdkvhostuser ofport_request=4
</code></pre></div></div> <p>Then, let’s configure the OVS flow fules to push traffic to and from VM’s ports.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo ovs-ofctl del-flows br0
sudo ovs-ofctl add-flow br0 in_port=1,actions=output:3
sudo ovs-ofctl add-flow br0 in_port=2,actions=output:4
sudo ovs-ofctl add-flow br0 in_port=3,actions=output:1
sudo ovs-ofctl add-flow br0 in_port=4,actions=output:2
</code></pre></div></div> <p>To check current configuration of OVS use:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo ovs-ofctl dump-flows br0
sudo ovs-ofctl dump-ports br0
sudo ovs-vsctl show
</code></pre></div></div> <p>Great! We have OVS-DPDK up and running. Now, let’s create and run Virtual Machine..</p> <h3 id="running-kvm-machine">Running KVM machine</h3> <p>In order to configure and run VMs we will use <em>virsh</em>. Before booting the VM up we need to prepare Host OS by configuring permissions for QEMU and hugepages to be used by VM’s ports.</p> <p>Edit <strong><em>/etc/libvirt/qemu.conf</em></strong> and modify the following lines to set “root” as the value of user and group:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user = "root"
group = "root"
</code></pre></div></div> <p>Then, restart libvirt:</p> <p><code class="language-plaintext highlighter-rouge">sudo systemctl restart libvirtd.service</code></p> <p>Now, mount hugepages to be used by QEMU:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo mkdir -p /dev/hugepages/libvirt
sudo mkdir -p /dev/hugepages/libvirt/qemu
sudo mount -t hugetlbfs hugetlbfs /dev/hugepages/libvirt/qemu
</code></pre></div></div> <p>Once done, we can run VM by using <em>virsh</em> and XML configuration file. I have prepared the pre-defined VM (testpmd.qcow2) with DPDK installed on. Moreover, I have prepared the user-data.img image with cloud init configuration, which configures password to login into VM. In order to generate user-data.img you can create a text file with the below content:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#cloud-config
password: Password1
chpasswd: { expire: False }
ssh_pwauth: True
</code></pre></div></div> <p>And generate .img file:</p> <p><code class="language-plaintext highlighter-rouge">cloud-localds user-data.img user-data</code></p> <p>Now, let’s create the XML file (let’s name it <em>demovm.xml</em>) for virsh. Refer to the XML file provided below. It will run the KVM machine with 8GB or RAM and 8 vCPUs. The VM will be attached to the OVS-DPDK ports. Note that you need to set the path to the OS image and user-data.img under the <disk> section.</disk></p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;domain</span> <span class="na">type=</span><span class="s">'kvm'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;name&gt;</span>demovm<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;uuid&gt;</span>4a9b3f53-fa2a-47f3-a757-dd87720d9d1d<span class="nt">&lt;/uuid&gt;</span>
  <span class="nt">&lt;memory</span> <span class="na">unit=</span><span class="s">'KiB'</span><span class="nt">&gt;</span>8388608<span class="nt">&lt;/memory&gt;</span>
  <span class="nt">&lt;currentMemory</span> <span class="na">unit=</span><span class="s">'KiB'</span><span class="nt">&gt;</span>8399608<span class="nt">&lt;/currentMemory&gt;</span>
  <span class="nt">&lt;memoryBacking&gt;</span>
    <span class="nt">&lt;hugepages&gt;</span>
      <span class="nt">&lt;page</span> <span class="na">size=</span><span class="s">'1'</span> <span class="na">unit=</span><span class="s">'G'</span> <span class="na">nodeset=</span><span class="s">'0'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/hugepages&gt;</span>
  <span class="nt">&lt;/memoryBacking&gt;</span>
  <span class="nt">&lt;vcpu</span> <span class="na">placement=</span><span class="s">'static'</span><span class="nt">&gt;</span>8<span class="nt">&lt;/vcpu&gt;</span>
  <span class="nt">&lt;cputune&gt;</span>
    <span class="nt">&lt;shares&gt;</span>4096<span class="nt">&lt;/shares&gt;</span>
    <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'0'</span> <span class="na">cpuset=</span><span class="s">'14'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'1'</span> <span class="na">cpuset=</span><span class="s">'15'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;emulatorpin</span> <span class="na">cpuset=</span><span class="s">'11,13'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/cputune&gt;</span>
  <span class="nt">&lt;os&gt;</span>
    <span class="nt">&lt;type</span> <span class="na">arch=</span><span class="s">'x86_64'</span> <span class="na">machine=</span><span class="s">'pc'</span><span class="nt">&gt;</span>hvm<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;boot</span> <span class="na">dev=</span><span class="s">'hd'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/os&gt;</span>
  <span class="nt">&lt;features&gt;</span>
    <span class="nt">&lt;acpi/&gt;</span>
    <span class="nt">&lt;apic/&gt;</span>
  <span class="nt">&lt;/features&gt;</span>
  <span class="nt">&lt;cpu</span> <span class="na">mode=</span><span class="s">'host-model'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;model</span> <span class="na">fallback=</span><span class="s">'allow'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;topology</span> <span class="na">sockets=</span><span class="s">'2'</span> <span class="na">cores=</span><span class="s">'4'</span> <span class="na">threads=</span><span class="s">'1'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;numa&gt;</span>
      <span class="nt">&lt;cell</span> <span class="na">id=</span><span class="s">'0'</span> <span class="na">cpus=</span><span class="s">'0-1'</span> <span class="na">memory=</span><span class="s">'4194304'</span> <span class="na">unit=</span><span class="s">'KiB'</span> <span class="na">memAccess=</span><span class="s">'shared'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/numa&gt;</span>
  <span class="nt">&lt;/cpu&gt;</span>
  <span class="nt">&lt;on_poweroff&gt;</span>destroy<span class="nt">&lt;/on_poweroff&gt;</span>
  <span class="nt">&lt;on_reboot&gt;</span>restart<span class="nt">&lt;/on_reboot&gt;</span>
  <span class="nt">&lt;on_crash&gt;</span>destroy<span class="nt">&lt;/on_crash&gt;</span>
  <span class="nt">&lt;devices&gt;</span>
    <span class="nt">&lt;emulator&gt;</span>/usr/bin/qemu-system-x86_64<span class="nt">&lt;/emulator&gt;</span>
    <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">'file'</span> <span class="na">device=</span><span class="s">'disk'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">'qemu'</span> <span class="na">type=</span><span class="s">'qcow2'</span> <span class="na">cache=</span><span class="s">'none'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;source</span> <span class="na">file=</span><span class="s">'/home/tomek/testpmd.qcow2'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">'vda'</span> <span class="na">bus=</span><span class="s">'virtio'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/disk&gt;</span>
    <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">'file'</span> <span class="na">device=</span><span class="s">'disk'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;source</span> <span class="na">file=</span><span class="s">'/home/tomek/user-data.img'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">'vdb'</span> <span class="na">bus=</span><span class="s">'virtio'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/disk&gt;</span>
    <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">'vhostuser'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">'00:00:00:00:00:01'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;source</span> <span class="na">type=</span><span class="s">'unix'</span> <span class="na">path=</span><span class="s">'/usr/local/var/run/openvswitch/dpdkvhostuser0'</span> <span class="na">mode=</span><span class="s">'client'</span><span class="nt">/&gt;</span>
       <span class="nt">&lt;model</span> <span class="na">type=</span><span class="s">'virtio'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;driver</span> <span class="na">queues=</span><span class="s">'2'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;host</span> <span class="na">mrg_rxbuf=</span><span class="s">'off'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/driver&gt;</span>
    <span class="nt">&lt;/interface&gt;</span>
    <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">'vhostuser'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">'00:00:00:00:00:02'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;source</span> <span class="na">type=</span><span class="s">'unix'</span> <span class="na">path=</span><span class="s">'/usr/local/var/run/openvswitch/dpdkvhostuser1'</span> <span class="na">mode=</span><span class="s">'client'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;model</span> <span class="na">type=</span><span class="s">'virtio'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;driver</span> <span class="na">queues=</span><span class="s">'2'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;host</span> <span class="na">mrg_rxbuf=</span><span class="s">'off'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/driver&gt;</span>
    <span class="nt">&lt;/interface&gt;</span>
    <span class="nt">&lt;serial</span> <span class="na">type=</span><span class="s">'pty'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;target</span> <span class="na">port=</span><span class="s">'0'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/serial&gt;</span>
    <span class="nt">&lt;console</span> <span class="na">type=</span><span class="s">'pty'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;target</span> <span class="na">type=</span><span class="s">'serial'</span> <span class="na">port=</span><span class="s">'0'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/console&gt;</span>
  <span class="nt">&lt;/devices&gt;</span>
<span class="nt">&lt;/domain&gt;</span>
</code></pre></div></div> <p>Once created, let’s run the KVM machine using virsh:</p> <p><code class="language-plaintext highlighter-rouge">virsh create demovm.xml</code></p> <p>Now, you can enter the console using:</p> <p><code class="language-plaintext highlighter-rouge">virsh console demovm</code></p> <p>When the VM will boot up you can login by using username: <em>ubuntu</em> and password: <em>Password1</em>.</p> <p>If you would like to test network performance of OVS-DPDK + VM deployment I recommend you to run testpmd app inside VM.</p> <p><a href="https://doc.dpdk.org/guides/testpmd_app_ug/build_app.html" rel="external nofollow noopener" target="_blank">Once the testpmd app is compiled</a>, let’s setup the DPDK ports inside VM and run testpmd:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo sysctl vm.nr_hugepages=1024
sudo mkdir -p /dev/hugepages
sudo mount -t hugetlbfs hugetlbfs /dev/hugepages
sudo modprobe uio
sudo insmod $DPDK_BUILD/kmod/igb_uio.ko
$DPDK_DIR/usertools/dpdk-devbind.py --status
sudo $DPDK_DIR/usertools/dpdk-devbind.py -b igb_uio 00:02.0 00:03.0
</code></pre></div></div> <p>Finally, let’s run the testpmd app, which will forward the traffic between two DPDK ports:</p> <p><code class="language-plaintext highlighter-rouge">sudo ./testpmd -n 4 --socket-mem 512 -- --burst=64 -i</code></p> <h3 id="summary">Summary</h3> <p>This post describes how to setup OVS-DPDK with VM. I hope it will be found useful for anyone, who will need to run OVS-DPDK with KVM. With this setup I was able to achieve about 8.5 Mpps (~7.5 Gbps) for small (74 Bytes) packets on HP ProLiant DL380 Gen9 server with 2x Intel(R) Xeon(R) CPU E5-2650 v3 @ 2.30GHz and 128 GB RAM.</p> <p>If you have any question regarding the configuration process or you faced a problem to reproduce the steps don’t hesitate to contact me.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/ovs-afxdp-installation/">OVS_AFXDP - step-by-step installation guide</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2017/vowifi-5g/">Initial view on VoWiFi in the 5G network</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2019/vxlan-tunneling-in-p4/">Implementing tunneling techniques in P4 based on the example of VXLAN</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/my-takeways-from-c-traps-and-pitfalls/">My takeways from the "C Traps and Pitfalls" book</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2018/network-prototyping-p4/">Network prototyping made easy with P4 and Python!</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Tomasz Osiński. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. Last updated: April 03, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?5d75c11f89cd96294bf5e6dd1ee1bb30"></script> <script defer src="/assets/js/common.js?fcfacfb8c6281f5e68d5a7d348186eb1"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>