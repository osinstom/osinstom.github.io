<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> My takeways from the "C Traps and Pitfalls" book | Making networks truly programmable! </title> <meta name="author" content="Tomasz Osiński"> <meta name="description" content="Making networks programmable by Tomasz Osiński "> <meta name="keywords" content="5G, Software-Defined Networking, NFV, P4, Telco Cloud"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?31447096772a8933d0b4c90f26018e76"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://osinstom.github.io/blog/2020/my-takeways-from-c-traps-and-pitfalls/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Making networks truly programmable! </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/about">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">My takeways from the "C Traps and Pitfalls" book</h1> <p class="post-meta"> February 05, 2020 </p> <p class="post-tags"> <a href="/blog/2020"> <i class="fa-solid fa-calendar fa-sm"></i> 2020 </a>   ·   <a href="/blog/tag/c"> <i class="fa-solid fa-hashtag fa-sm"></i> C</a>   <a href="/blog/tag/programming"> <i class="fa-solid fa-hashtag fa-sm"></i> programming</a>     ·   <a href="/blog/category/article"> <i class="fa-solid fa-tag fa-sm"></i> article</a>   </p> </header> <article class="post-content"> <div id="table-of-contents"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h3"><a href="#1-precendence-of-operators">1. Precendence of operators</a></li> <li class="toc-entry toc-h3"><a href="#2-mind-a-break-statement">2. Mind a break statement!</a></li> <li class="toc-entry toc-h3"><a href="#3-dangling-else-problem">3. Dangling else problem</a></li> <li class="toc-entry toc-h3"><a href="#4-order-of-evaluation">4. Order of evaluation</a></li> <li class="toc-entry toc-h3"><a href="#5-logical-vs-bitwise-comparison">5. Logical vs. bitwise comparison</a></li> <li class="toc-entry toc-h3"><a href="#6-c-doesnt-cast-functions-arguments-automatically">6. C doesn’t cast function’s arguments automatically!</a></li> <li class="toc-entry toc-h3"><a href="#7-allocate-enough-memory-for-strings">7. Allocate enough memory for strings</a></li> <li class="toc-entry toc-h3"><a href="#8-integer-overflow">8. Integer overflow</a></li> <li class="toc-entry toc-h3"><a href="#9-how-to-shift-bits">9. How to shift bits?</a></li> <li class="toc-entry toc-h3"><a href="#10-what-c-preprocessor-gives-us">10. What C preprocessor gives us?</a></li> <li class="toc-entry toc-h3"><a href="#11-macros-are-not-functions">11. Macros are not functions</a></li> <li class="toc-entry toc-h3"><a href="#12-macros-are-not-typedefs">12. Macros are not typedefs</a></li> <li class="toc-entry toc-h3"><a href="#13-c-is-not-really-portable">13. C is not really portable</a></li> <li class="toc-entry toc-h2"><a href="#summary">Summary</a></li> </ul> </div> <hr> <div id="markdown-content"> <p>Recently, I read the really nice book, entitled “C Traps and Pitfalls”, to extend my competences in C. This post gathers all my key findings and takeways from this book. I wrote this more for myself to note the key findings, but I think any C programmer can find something useful in my notes. Enjoy!</p> <h3 id="1-precendence-of-operators">1. Precendence of operators</h3> <p>Before going into the topic, quick reminder on what operators do we have in C:</p> <ul> <li> <strong>Arithmetic operators</strong> - math operators such as <code class="language-plaintext highlighter-rouge">+</code>, <code class="language-plaintext highlighter-rouge">-</code>, <code class="language-plaintext highlighter-rouge">*</code>, <code class="language-plaintext highlighter-rouge">/</code>, <code class="language-plaintext highlighter-rouge">%</code> </li> <li> <strong>Increment and decrement operators</strong> - two operators (<code class="language-plaintext highlighter-rouge">++</code> and <code class="language-plaintext highlighter-rouge">--</code>) to change the value of an operand by one.</li> <li> <strong>Assignment operators</strong> - for assigning the value to a variable: <code class="language-plaintext highlighter-rouge">=</code>, <code class="language-plaintext highlighter-rouge">+=</code>, <code class="language-plaintext highlighter-rouge">-=</code>, <code class="language-plaintext highlighter-rouge">*=</code>, <code class="language-plaintext highlighter-rouge">/=</code>, <code class="language-plaintext highlighter-rouge">%=</code>.</li> <li> <strong>Relational operators</strong> - used in decision making or loops to check the relationship between two operands: <code class="language-plaintext highlighter-rouge">==</code>, <code class="language-plaintext highlighter-rouge">&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;</code>, <code class="language-plaintext highlighter-rouge">!=</code>, <code class="language-plaintext highlighter-rouge">&gt;=</code>, <code class="language-plaintext highlighter-rouge">&lt;=</code>.</li> <li> <strong>Logical operators</strong> - to perform logical operations: <code class="language-plaintext highlighter-rouge">&amp;&amp;</code> (AND), <code class="language-plaintext highlighter-rouge">||</code> (OR), <code class="language-plaintext highlighter-rouge">!</code> (NOT)</li> <li> <strong>Bitwise operators</strong> - to perform operation on bits: <code class="language-plaintext highlighter-rouge">&amp;</code>, <code class="language-plaintext highlighter-rouge">|</code>, <code class="language-plaintext highlighter-rouge">^</code>, <code class="language-plaintext highlighter-rouge">~</code>, <code class="language-plaintext highlighter-rouge">&lt;&lt;</code>, <code class="language-plaintext highlighter-rouge">&gt;&gt;</code>.</li> </ul> <p>Except for above, there are two simple operators: sizeof and Comma operator.</p> <p>Now, where does the precendence of operators matter? In general, in any statement of the C program, but we would meet the most surprising traps in the <em>if</em> statements. According to the example from book, we could write the following statement to check if variable <code class="language-plaintext highlighter-rouge">flags</code> has some bit (represented as <code class="language-plaintext highlighter-rouge">FLAG</code>) turned on:</p> <pre><code class="language-C">if (flags &amp; FLAG != 0) ...
</code></pre> <p>Sic! The relational operator (<code class="language-plaintext highlighter-rouge">!=</code>) has the precendence over the bitwise operator (<code class="language-plaintext highlighter-rouge">&amp;</code>), so it totally changes our intention! The statement firstly compare <code class="language-plaintext highlighter-rouge">FLAG</code> with 0 and, then, takes the result of comparison and performs logical AND operation with flags. This was not our intention!</p> <p>In the book, there are more examples of such a traps in C. What we should remember is:</p> <blockquote> <p>The precendence of operators in C is as follows (from the highest precendence): The arithmetic operators, the shift operators, the relational operators, the logical operators, the assignment operators, the conditional operator.</p> </blockquote> <p>To conclude this paragraph, the operator’s precendence in C can make a lot of surprises for not experienced programmer.</p> <blockquote> <p>My hint? Use as much parenthesess as you need, but not more than really required, in the <em>if</em> statements to express your intention. You will avoid a lot of surprises this way.</p> </blockquote> <h3 id="2-mind-a-break-statement">2. Mind a break statement!</h3> <p>In the <em>switch</em> statement each <em>case</em> statement should be terminated with <em>break</em>. Otherwise, all the subsequent <em>case</em> statements will be also invoked until the first <em>break</em> ! Note that this trap may also be a nice feature of the language if used intentionally (e.g. in the compiler program to skip some tokens while analyzing the code).</p> <h3 id="3-dangling-else-problem">3. Dangling <em>else</em> problem</h3> <p>Consider the following example from the book:</p> <pre><code class="language-C">if (x == 0)
  if (y == 0) error();
else {
  z = x + y;
  f(&amp;z);
}
</code></pre> <p>The intention here is to enter <em>else</em> block if <code class="language-plaintext highlighter-rouge">x != 0</code>. However, in C, <em>else</em> is associated with the nearest <em>if</em> statement! Therefore, in the above example <em>else</em> statement will be invoked if <code class="language-plaintext highlighter-rouge">y != 0</code> (sic!).</p> <blockquote> <p>My hint? You should always use parenthesses in the <em>if-else</em> statements to make sure that C program behaves as you intended to.</p> </blockquote> <h3 id="4-order-of-evaluation">4. Order of evaluation</h3> <p>Order of evaluation for most operators in the C language is not defined. The compiler is free to evaluate such expressions in any order, if the compiler can guarantee a consistent results.</p> <p>The only the following operators specify and guarantee the particular order of evalation: sequential-evaluation (<code class="language-plaintext highlighter-rouge">,</code>), logical-AND (<code class="language-plaintext highlighter-rouge">&amp;&amp;</code>), logical-OR (<code class="language-plaintext highlighter-rouge">||</code>) and conditional expression (<code class="language-plaintext highlighter-rouge">? :</code>).</p> <p>All other C operands evalute their operands in undefined order. It means their exact behavior is implementation-specific/</p> <h3 id="5-logical-vs-bitwise-comparison">5. Logical vs. bitwise comparison</h3> <p>Anyone should avoid using logical (e.g. <code class="language-plaintext highlighter-rouge">&amp;&amp;</code>) and bitwise (<code class="language-plaintext highlighter-rouge">&amp;</code>) operators, interchangebly. For experienced programmers, it is obvious that these operators are not equivalent to each other. However, young programmers can substitute bitwise operator for logical operators or vice versa.</p> <p>In general the rule is simple:</p> <blockquote> <p>Logical operators treats their arguments as either “True” (value 1) or “False” (value 0). On the other hand, bitwise operators work on sequence of bits and compares bits of their arguments.</p> </blockquote> <p>According to the following example (from book):</p> <pre><code class="language-C">i = 0;
while (i &lt; tabsize &amp;&amp; tab[i] != x)
  i++;
</code></pre> <p>If the <code class="language-plaintext highlighter-rouge">&amp;&amp;</code> would be replaced by <code class="language-plaintext highlighter-rouge">&amp;</code> we will have two consequences:</p> <ol> <li>In this example, both comparisons produce the value of 0 or 1, so that <code class="language-plaintext highlighter-rouge">&amp;</code> and <code class="language-plaintext highlighter-rouge">&amp;&amp;</code> will work similarily. However, if one of the comparisons would produce some other value, the loop would work incorrectly.</li> <li>This is really tricky and can make a surprise! The <code class="language-plaintext highlighter-rouge">&amp;</code>, unlike <code class="language-plaintext highlighter-rouge">&amp;&amp;</code>, must <strong>always</strong> evaluate both of its operands. So, even if <code class="language-plaintext highlighter-rouge">i &lt; tabsize</code> is “False”, the second operand (<code class="language-plaintext highlighter-rouge">tab[i] != x</code>) will be evaluated! In this case, it leads to reading a value that is not in the bounds of the <code class="language-plaintext highlighter-rouge">tab</code> array.</li> </ol> <p>It is worth to remember these consequences as the recruiters like to ask this sort of questions at job interview :)</p> <h3 id="6-c-doesnt-cast-functions-arguments-automatically">6. C doesn’t cast function’s arguments automatically!</h3> <p>In other words:</p> <blockquote> <p>It is the programmer’s responsibility to ensure that the arguments toa function are of the right type.</p> </blockquote> <h3 id="7-allocate-enough-memory-for-strings">7. Allocate enough memory for strings</h3> <p>String is an array of characters, but this array is terminated with <code class="language-plaintext highlighter-rouge">'\0'</code> (null character). Therefore, we need allocate one extra character for string! For example, if <code class="language-plaintext highlighter-rouge">strlen(s)</code> equals <code class="language-plaintext highlighter-rouge">n</code>, <code class="language-plaintext highlighter-rouge">s</code> really requires <code class="language-plaintext highlighter-rouge">n+1</code> characters to be allocated.</p> <h3 id="8-integer-overflow">8. Integer overflow</h3> <blockquote> <p>If either operand is unsigned, the result is unsigned, and is defined to be modulo 2^n, where “n” is the word size. If both operands are signed, the result is <strong>undefined</strong>.</p> </blockquote> <h3 id="9-how-to-shift-bits">9. How to shift bits?</h3> <ol> <li> <p>It is more safe to right-shift <em>unsigned</em> integers. In some implementations, if the item is <em>signed</em>, it is allowed to fill vacatated bit positions either with zeros or with copies of the sign bit. The latter can make a surprise!</p> </li> <li> <p>It is not allowed to shift the variable by value greater than its length.</p> </li> </ol> <h3 id="10-what-c-preprocessor-gives-us">10. What C preprocessor gives us?</h3> <ol> <li>We can change all instances of a particular quantity by changing one number (in only one place) and recompiling the program. It is useful for some pre-defined variables like size of char arrays etc.</li> <li>We can define things to appear as functions, but without typical execution overhead, which applies to classical function calls. Preprocessor just replaces a function call inline with predefined operations defined in macros.</li> </ol> <h3 id="11-macros-are-not-functions">11. Macros are not functions</h3> <p>This statements is rather obvious for everyone, who has been working with C for some time now. However, it can be misunderstood by beginners.</p> <p>Even though macros usually looks like function calls, they are not the same! Come back to takeways #10 and remember: preprocessor replaces all macros instances with actual value of a macro. This may lead to surprises for less experienced programmers.</p> <p>In my personal opinion, macros should be used mindfully, because they are not always the best option. The macros imitating functions sometimes looks really ugly and far away from “clean code” principles. My hint?</p> <blockquote> <p>Use macros to imitate function only if a function is not complex. Otherwise, use typical functions to make a code more readable.</p> </blockquote> <h3 id="12-macros-are-not-typedefs">12. Macros are not typedefs</h3> <p>In C, there is a construct called <em>typedef</em>, which allows programmer to create new types. However, macros are also used to define new types. The rule to remember is that macros are not typedefs and can lead to a surprise. Consider below example (from book):</p> <pre><code class="language-C">// T1 and T2 conceptually seems to define the same type (pointer to a struct foo).
#define T1 struct foo *
typedef struct foo *T2;

// declarations
T1 a, b;
T2 c, d;
</code></pre> <p>Now, there is a surprise! Remember macros replaces its instances with the actual value. As a result we have:</p> <pre><code class="language-C">struct foo * a, b;
</code></pre> <p>So, “a” is a pointer to a struct foo, indeed. However, “b” is just a variable of type struct foo!</p> <h3 id="13-c-is-not-really-portable">13. C is not really portable</h3> <p>The chapter 7 of the book deals with portability pitfalls. To summarize this chapter it is really easy to say that C is not really portable language and every programmer needs to know, which platform she or he is programming on. A programmer has to know about underlaying platform’s features, libraries and limitations.</p> <p>What authors recommend to look at regarding portability?</p> <ul> <li>Case sensitivness - not all platforms/compilers are sensitive to case in names of variables/functions.</li> <li>Size of integers - the size is architecture-dependent. Usually we have 32 bit for integers, 16 bit for <em>short</em>, etc. However, it is not guaranteed.</li> <li>Converting char to int - it is not defined if a character should be transformed to unsigned or signed integer. If one wants to force conversion to unsigned integer it is better to declare <em>unsigned char</em>. In this case, extra bit positions should be filled with zeros. If casting from <em>char</em> it depends on implementation - a compiler may convert it to signed or unsigned integer.</li> <li>Random numbers - due to historical reasons, it is undefined what is an upper bound for randomly-generated number. However, it is granted to be at least 2^15-1.</li> </ul> <h2 id="summary">Summary</h2> <p>This book was a nice journey for me! As I spent a lot of time on programming C software during last year, it was not a revolutionary book for me. Nevertheless, it definetely expand my knowledge about C and I’m sure it provides a strong background and deep knowledge about specific constructs of C.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2018/network-prototyping-p4/">Network prototyping made easy with P4 and Python!</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/p4c-ubpf-the-new-back-end-for-the-p4-compiler/">p4c-ubpf - the new back-end for the P4 compiler!</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2019/vxlan-tunneling-in-p4/">Implementing tunneling techniques in P4 based on the example of VXLAN</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2019/configuring-ovs-dpdk-with-vm/">Configuring OVS-DPDK with VM</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/ovs-afxdp-installation/">OVS_AFXDP - step-by-step installation guide</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Tomasz Osiński. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. Last updated: April 03, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?5d75c11f89cd96294bf5e6dd1ee1bb30"></script> <script defer src="/assets/js/common.js?fcfacfb8c6281f5e68d5a7d348186eb1"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>