<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> p4c-ubpf - the new back-end for the P4 compiler! | Making networks truly programmable! </title> <meta name="author" content="Tomasz Osiński"> <meta name="description" content="Making networks programmable by Tomasz Osiński "> <meta name="keywords" content="5G, Software-Defined Networking, NFV, P4, Telco Cloud"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="/assets/img/favicon.png?31447096772a8933d0b4c90f26018e76"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://osinstom.github.io/blog/2020/p4c-ubpf-the-new-back-end-for-the-p4-compiler/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Making networks truly programmable! </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/about">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">p4c-ubpf - the new back-end for the P4 compiler!</h1> <p class="post-meta"> February 06, 2020 </p> <p class="post-tags"> <a href="/blog/2020"> <i class="fa-solid fa-calendar fa-sm"></i> 2020 </a>   ·   <a href="/blog/tag/p4"> <i class="fa-solid fa-hashtag fa-sm"></i> P4</a>   <a href="/blog/tag/ubpf"> <i class="fa-solid fa-hashtag fa-sm"></i> uBPF</a>     ·   <a href="/blog/category/article"> <i class="fa-solid fa-tag fa-sm"></i> article</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>NOTE: This blog post was originally published on P4.org: https://opennetworking.org/news-and-events/blog/p4c-ubpf-a-new-back-end-for-the-p4-compiler/.</p> <hr> <p>With the constant development of the P4 language more and more programmable targets are emerging. The P4 compiler has already support for the next-generation Linux datapath such as eBPF/XDP. However, it is sometimes required to introduce runtime extensibility mechanism in a user-space packet processing applications. It can be achieved by using <a href="https://github.com/iovisor/ubpf" rel="external nofollow noopener" target="_blank">the user-space BPF (uBPF) Virtual Machine</a>, which is a re-implementation of in-kernel eBPF VM and provides a user-space execution environment, which can be extended at runtime.</p> <p>This blog post introduces <strong>p4c-ubpf</strong> - the new back-end for the P4 compiler - that enables programming packet processing modules for uBPF. The p4c-ubpf allows to execute the P4 code in any solution implementing the kernel bypass (e.g. DPDK or AF_XDP applications).</p> <h1 id="userspace-bpf-for-packet-processing">Userspace BPF for packet processing</h1> <h2 id="why-ubpf">Why uBPF?</h2> <p>The uBPF project [1] re-implements the eBPF kernel-based Virtual Machine. It contains eBPF assembler, disassembler, interpreter, and JIT compiler for x86-64. While the BPF programs are intented to be run in the kernel, the uBPF project enables running the BPF programs in user-space applications. Therefore, the uBPF Virtual Machine can be well-integrated with the kernel bypass (e.g. DPDK/AF_XDP) applications.</p> <p>Moreover, contrary to the eBPF implementation, uBPF is not licensed under GPL. The uBPF implementation is licensed under Apache License, version 2.0. Finally, the userspace eBPF implements less complex virtual machine, so that some constructs are not supported (e.g. tail calls), but, on the other hand, the stack size of the uBPF program is not limited to 512 bytes.</p> <h2 id="p4rt-ovs">P4rt-OVS</h2> <p>Open vSwitch (OVS) is a widely adopted high-performance programmable virtual switch. P4rt-OVS is an extension of Open vSwitch that integrates the BPF virtual machine with the userspace datapath of OVS. Hence, P4rt-OVS allows to extend the OVS packet processing pipeline without recompilation by injecting BPF programs at runtime. BPF programs act as programmable actions and they are referenced as a new OVS action (keyword <code class="language-plaintext highlighter-rouge">prog</code>) in the OpenFlow tables. Programmable actions are allowed to write to packets as well as read and write to persistent maps (hash tables) to retain information on flows.</p> <p>Furthermore, a user can use the P4 language to develop new, protocol-independent data plane extensions (BPF programs) for Open vSwitch. P4 provides a high-level and declarative language, so writing a new network features becomes super easy! p4c-ubpf, the uBPF back-end for the P4 compiler, provides the architecture model to write P4 programs making use of wide range of P4 features including stateful registers.</p> <h1 id="compiling-p4-to-ubpf">Compiling P4 to uBPF</h1> <p>The P4-to-uBPF compiler follows the same convention as P4 compilers for eBPF or XDP backends, i.e. the P4 program is firstly translated to the C representation and, then, compiled to the BPF code using <code class="language-plaintext highlighter-rouge">clang</code> compiler. It makes things a little bit easier as P4 compiler does not need to generate low-level BPF instructions.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            ------------              ---------
P4_16 ---&gt;  | p4c-ubpf | ---&gt; C ----&gt; | clang | --&gt; uBPF
            ------------              ---------
</code></pre></div></div> <p>We designed a new architecture model for P4c-uBPF (depicted below). The <code class="language-plaintext highlighter-rouge">ubpf_model</code> architecture consists of a single parser, match-action pipeline, and deparser. We made the decision to disable packet forwarding in the first version, what simplifies the design, but can be treated as a limitation. It means it is the responsibility of the underlaying target to determine output port for incoming packets. P4rt-OVS is implemented according to this design principle. However, p4c-ubpf can be enhanced to support packet forwarding in the next releases.</p> <p><img src="/en/_posts/p4c-ubpf-architecture-model.png" alt="p4c-ubpf-architecture-model.png"></p> <p>The p4c-ubpf compiler provides also a library of <em>extern</em> functions that implement features not supported by the P4 language. These functions can be called from the P4 program as a normal action. The <code class="language-plaintext highlighter-rouge">ubpf</code> architecture model supports such operations as hash functions, stateful registers, timestamp retrieving and checksum computation. To see the heavily commented, full specification of the architecture model see <a href="https://github.com/p4lang/p4c/blob/master/backends/ubpf/p4include/ubpf_model.p4" rel="external nofollow noopener" target="_blank">this link</a>.</p> <h2 id="translating-p4-to-c">Translating P4 to C</h2> <p>The key operation that is performed by p4c-ubpf is translation from P4 to C. The following tables provide a brief summary of how each P4 construct is mapped to a corresponding C construct. Note that the translation is very similar to <code class="language-plaintext highlighter-rouge">p4c-ebpf</code> and <code class="language-plaintext highlighter-rouge">p4c-xdp</code>.</p> <h4 id="translating-parser">Translating parser</h4> <table> <thead> <tr> <th>P4 Construct</th> <th>C Translation</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">header</code></td> <td> <code class="language-plaintext highlighter-rouge">struct</code> type with an additional <code class="language-plaintext highlighter-rouge">valid</code> bit</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">struct</code></td> <td><code class="language-plaintext highlighter-rouge">struct</code></td> </tr> <tr> <td>parser state</td> <td>code block</td> </tr> <tr> <td>state transition</td> <td> <code class="language-plaintext highlighter-rouge">goto</code> statement</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">extract</code></td> <td>load/shift/mask data from packet buffer</td> </tr> </tbody> </table> <h4 id="translating-match-action-pipelines">Translating match-action pipelines</h4> <table> <thead> <tr> <th>P4 Construct</th> <th>C Translation</th> </tr> </thead> <tbody> <tr> <td>table</td> <td>eBPF map</td> </tr> <tr> <td>table key</td> <td> <code class="language-plaintext highlighter-rouge">struct</code> type</td> </tr> <tr> <td>table <code class="language-plaintext highlighter-rouge">actions</code> block</td> <td>tagged <code class="language-plaintext highlighter-rouge">union</code> with all possible actions</td> </tr> <tr> <td> <code class="language-plaintext highlighter-rouge">action</code> arguments</td> <td><code class="language-plaintext highlighter-rouge">struct</code></td> </tr> <tr> <td>table <code class="language-plaintext highlighter-rouge">reads</code> </td> <td>eBPF map’s lookups</td> </tr> <tr> <td> <code class="language-plaintext highlighter-rouge">action</code> body</td> <td>code block</td> </tr> <tr> <td>table <code class="language-plaintext highlighter-rouge">apply</code> </td> <td> <code class="language-plaintext highlighter-rouge">switch</code> statement</td> </tr> <tr> <td>registers</td> <td>additional eBPF map</td> </tr> <tr> <td>register <code class="language-plaintext highlighter-rouge">reads</code> </td> <td>eBPF map’s lookups</td> </tr> <tr> <td>register <code class="language-plaintext highlighter-rouge">writes</code> </td> <td>eBPF map’s updates</td> </tr> </tbody> </table> <h4 id="translating-deparser">Translating deparser</h4> <table> <thead> <tr> <th>P4 Construct</th> <th>C Translation</th> </tr> </thead> <tbody> <tr> <td> <code class="language-plaintext highlighter-rouge">apply</code> block</td> <td>code block + adjusting packet’s size</td> </tr> <tr> <td> <code class="language-plaintext highlighter-rouge">emit</code> operation</td> <td>header’s validity check + write/shift/mask data to packet buffer</td> </tr> </tbody> </table> <h1 id="p4c-ubpf-vs-other-bpf-related-compilers">p4c-ubpf vs. other BPF-related compilers</h1> <p>The uBPF is yet another BPF-related backend for P4. <code class="language-plaintext highlighter-rouge">p4c-ebpf</code> generates programs to be attached to the Linux TC subsystem, <code class="language-plaintext highlighter-rouge">p4c-xdp</code> targets XDP hook, while <code class="language-plaintext highlighter-rouge">p4c-ubpf</code> produces code to be run in at the user-space level. There are differences in the range of functionalities that these P4 backends support. The table below provides a brief comparison of features provided by each BPF-related backend.</p> <h4 id="comparsion-of-features-provided-by-p4c-ebpf-p4c-xdp-and-p4c-ubpf">Comparsion of features provided by p4c-ebpf, p4c-xdp and p4c-ubpf</h4> <table> <thead> <tr> <th style="text-align: center">Feature</th> <th style="text-align: center">p4c-ebpf</th> <th style="text-align: center">p4c-xdp</th> <th style="text-align: center">p4c-ubpf</th> </tr> </thead> <tbody> <tr> <td style="text-align: center">Packet filtering</td> <td style="text-align: center">YES</td> <td style="text-align: center">YES</td> <td style="text-align: center">YES</td> </tr> <tr> <td style="text-align: center">Packet’s modifications &amp; tunneling</td> <td style="text-align: center">NO</td> <td style="text-align: center">YES</td> <td style="text-align: center">YES</td> </tr> <tr> <td style="text-align: center">Simple packet forwarding</td> <td style="text-align: center">YES</td> <td style="text-align: center">YES</td> <td style="text-align: center">NO</td> </tr> <tr> <td style="text-align: center">Registers</td> <td style="text-align: center">NO</td> <td style="text-align: center">NO</td> <td style="text-align: center">YES</td> </tr> <tr> <td style="text-align: center">Counters</td> <td style="text-align: center">YES</td> <td style="text-align: center">YES</td> <td style="text-align: center">NO</td> </tr> <tr> <td style="text-align: center">Checksum computation</td> <td style="text-align: center">NO</td> <td style="text-align: center">YES</td> <td style="text-align: center">YES</td> </tr> </tbody> </table> <h1 id="summary">Summary</h1> <p>The uBPF backend for the P4 compiler can be used for any application that processes packets in a user space. It has already been used to implement various, simple applications such as stateful firewall, rate limiter or GTP tunneling. For instance, in case of P4rt-OVS, <code class="language-plaintext highlighter-rouge">p4c-ubpf</code> allows to implement network protocols, which are not currently supported by Open vSwitch. See <a href="https://github.com/p4lang/p4c/tree/master/backends/ubpf/examples" rel="external nofollow noopener" target="_blank">this link</a> for more examples.</p> <p>We encourage community to start playing with uBPF backend, report bugs and propose new enhancements. For questions or comments, please send an email to tomasz.osinski2@orange.com.</p> <h1 id="quick-links">Quick links</h1> <p><a href="https://docs.cilium.io/en/v1.6/bpf/" rel="external nofollow noopener" target="_blank">BPF and XDP Reference Guide</a></p> <p><a href="https://github.com/p4lang/p4c/blob/master/backends/ebpf/README.md" rel="external nofollow noopener" target="_blank">Background on P4 and eBPF</a></p> <p><a href="https://www.openvswitch.org/support/ovscon2019/#4.3F" rel="external nofollow noopener" target="_blank">P4-uBPF - presentation from Open vSwitch and OVN Fall 2019 conference</a></p> <p><a href="https://github.com/Orange-OpenSource/p4rt-ovs" rel="external nofollow noopener" target="_blank">P4rt-OVS - Github repository</a></p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2018/network-prototyping-p4/">Network prototyping made easy with P4 and Python!</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2019/vxlan-tunneling-in-p4/">Implementing tunneling techniques in P4 based on the example of VXLAN</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/ovs-afxdp-installation/">OVS_AFXDP - step-by-step installation guide</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/my-notes-from-podcast-why-doesn-t-ovs-support-p4/">My notes from podcast "Why doesn't OVS support P4?"</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/my-takeways-from-c-traps-and-pitfalls/">My takeways from the "C Traps and Pitfalls" book</a> </li> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Tomasz Osiński. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. Last updated: April 03, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?5d75c11f89cd96294bf5e6dd1ee1bb30"></script> <script defer src="/assets/js/common.js?fcfacfb8c6281f5e68d5a7d348186eb1"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>